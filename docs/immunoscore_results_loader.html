<!DOCTYPE html>

<html>
<head>
  <title>immunoscore_results_loader.rb</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="analyzer.html">
                analyzer.rb
              </a>
            
              
              <a class="source" href="cli.html">
                cli.rb
              </a>
            
              
              <a class="source" href="data_struct.html">
                data_struct.rb
              </a>
            
              
              <a class="source" href="database_connection.html">
                database_connection.rb
              </a>
            
              
              <a class="source" href="exporter.html">
                exporter.rb
              </a>
            
              
              <a class="source" href="immunoscore_results_loader.html">
                immunoscore_results_loader.rb
              </a>
            
              
              <a class="source" href="mongo_aggregator.html">
                mongo_aggregator.rb
              </a>
            
              
              <a class="source" href="semicolon_cleaner.html">
                semicolon_cleaner.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>immunoscore_results_loader.rb</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright (c) 2014, Carlo B. Bifulco. All rights reserved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">require</span> <span class="hljs-string">"csv"</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">"yaml"</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">"mongo_mapper"</span>
require_relative <span class="hljs-string">"database_connection"</span>
require_relative <span class="hljs-string">"analyzer"</span>
require_relative <span class="hljs-string">"data_struct"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="pull-info-from-definiens-immunoscore-directories">Pull info from Definiens Immunoscore Directories</h2>
<p>pattern matching based</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>filename convetions
RS_SP02-15779-A8__CD3_2013…
no underscores in the file name after the RS prefix
they are required before and after case number for pattern matching</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3 id="a-few-examples-of-what-we-are-looking-for">A few examples of what we are looking for</h3>
<p>image_0000006499_Classification.jpg
image_0000006504_Original.jpg
.image_0000006506_densitymap_new.jpg
.image_0000006506_histogram.jpg
image_0000006506_CT1.jpg. CT2, CT3
IM1, IM2, IM3</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="where-all-the-definies-stuff-resides">Where all the Definies stuff resides</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-constant">BASE_DIR</span>=<span class="hljs-constant">YAML</span>.load_file(<span class="hljs-string">"./config.yaml"</span>)[<span class="hljs-string">"base_dir"</span>] <span class="hljs-keyword">or</span> <span class="hljs-string">"/Volumes/cbb_transfer"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>BASE_DIR=”/Volumes/I\$/Christopher\ Paustian/Colon\ Immunoscore”</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="regex-utilities">regex utilities</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>pull_cd path
  path.match(<span class="hljs-regexp">/.*(CD[8|3]).*/</span>)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> path.match(<span class="hljs-regexp">/.*(CD[8|3]).*/</span>)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>pull_ct path
  pattern=<span class="hljs-regexp">/.*(CT[1|2|3|4|5|6|7|8])\.jpg/</span>
  path.match(pattern)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> path.match(pattern)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>pull_im path
  pattern=<span class="hljs-regexp">/.*(IM[1|2|3|4|5|6|7|8])\.jpg/</span>
  path.match(pattern)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> path.match(pattern)
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="case-identification">Case identification</h3>
<p>matched file names staring with RS follow by either - or <em> followed by SP03
followed by either - or </em> followed by case number.  Matching of teh block
number is not included </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>get_case_n path
  match=path.match(<span class="hljs-regexp">/(RS[_-].?.?.?.?.[-_]\d*)/i</span>)
  match[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> match
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="core-function">core function</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_files file_name_ending=<span class="hljs-string">"*Classification.jpg"</span>, base_dir=<span class="hljs-constant">BASE_DIR</span>
  results=[]
  <span class="hljs-constant">Dir</span>.glob(<span class="hljs-string">"<span class="hljs-subst">#{base_dir}</span>/**/<span class="hljs-subst">#{file_name_ending}</span>"</span>).each <span class="hljs-keyword">do</span> |full_path|
    puts <span class="hljs-string">"am  working on <span class="hljs-subst">#{full_path}</span>"</span>
    directory_name=full_path.split(<span class="hljs-string">"\/"</span>)[-<span class="hljs-number">4</span>]
    case_name=get_case_n full_path
    cd=directory_name.split(<span class="hljs-string">"_"</span>)[<span class="hljs-number">2</span>]
    results &lt;&lt; {<span class="hljs-symbol">:case_n=&gt;case_name</span>,
                <span class="hljs-symbol">:cd_type</span> =&gt;cd,
                <span class="hljs-symbol">:path=&gt;full_path</span>}
  <span class="hljs-keyword">end</span>
  results
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="special-functions">special functions</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_ct 
  find_files(file_name_ending=<span class="hljs-string">"*image*CT*.jpg"</span>).map{|x| x[<span class="hljs-symbol">:path</span>]}.map <span class="hljs-keyword">do</span> |path|
    case_n=get_case_n path
    cd =pull_cd(path)
    tile=pull_ct path
    {<span class="hljs-symbol">:cd_type=&gt;cd</span>, <span class="hljs-symbol">:path=&gt;path</span>, <span class="hljs-symbol">:tile=&gt;tile</span>, <span class="hljs-symbol">:case_n=&gt;case_n</span>, <span class="hljs-symbol">:type=&gt;</span><span class="hljs-symbol">:ct_tile</span>}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_im
  find_files(file_name_ending=<span class="hljs-string">"*image*IM*.jpg"</span>).map{|x| x[<span class="hljs-symbol">:path</span>]}.map <span class="hljs-keyword">do</span> |path|
    case_n=get_case_n path
    cd =pull_cd(path)
    tile=pull_im path
    {<span class="hljs-symbol">:cd_type=&gt;cd</span>, <span class="hljs-symbol">:path=&gt;path</span>, <span class="hljs-symbol">:tile=&gt;tile</span>, <span class="hljs-symbol">:case_n=&gt;case_n</span>,<span class="hljs-symbol">:type=&gt;</span><span class="hljs-symbol">:im_tile</span>}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_classification
  find_files(file_name_ending=<span class="hljs-string">"*Classification.jpg"</span>).map <span class="hljs-keyword">do</span> |x|
    x.merge({<span class="hljs-symbol">:type</span> =&gt; <span class="hljs-symbol">:classification</span>})
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_original
  find_files(file_name_ending=<span class="hljs-string">"*Original.jpg"</span>).map <span class="hljs-keyword">do</span> |x|
     x.merge({<span class="hljs-symbol">:type</span> =&gt; <span class="hljs-symbol">:original</span>})
   <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_statistics
  find_files(file_name_ending=<span class="hljs-string">"*Statistics.csv"</span>).map <span class="hljs-keyword">do</span> |x|
    puts x
    {<span class="hljs-symbol">:case_n=&gt;</span> x[<span class="hljs-symbol">:case_n</span>],
     <span class="hljs-symbol">:path=&gt;</span> x[<span class="hljs-symbol">:path</span>],
     <span class="hljs-symbol">:cd_type=&gt;pull_cd</span>(x[<span class="hljs-symbol">:path</span>]),
    <span class="hljs-symbol">:type=&gt;</span> <span class="hljs-symbol">:statistic</span>}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_density
   find_files(file_name_ending=<span class="hljs-string">"*densitymap*.jpg"</span>).map <span class="hljs-keyword">do</span> |x|
    path=x[<span class="hljs-symbol">:path</span>]
    case_n=get_case_n path
    new_old=path.gsub(<span class="hljs-string">".jpg"</span>,<span class="hljs-string">""</span>)[-<span class="hljs-number">3</span>..-<span class="hljs-number">1</span>]
    {<span class="hljs-symbol">:path=&gt;path</span>, <span class="hljs-symbol">:case_n=&gt;case_n</span>, <span class="hljs-symbol">:new_old=&gt;new_old</span>, 
      <span class="hljs-symbol">:cd_type=&gt;pull_cd</span>(path),<span class="hljs-symbol">:type=&gt;</span><span class="hljs-symbol">:density</span>}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>find_histogram
  find_files(file_name_ending=<span class="hljs-string">"*histogram.jpg"</span>).map <span class="hljs-keyword">do</span> |x|
    path=x[<span class="hljs-symbol">:path</span>]
    case_n=get_case_n path
    cd=pull_cd(path)
    {<span class="hljs-symbol">:path=&gt;path</span>, <span class="hljs-symbol">:case_n=&gt;case_n</span>,<span class="hljs-symbol">:type=&gt;</span><span class="hljs-symbol">:histogram</span>, <span class="hljs-symbol">:cd_type=&gt;cd</span>}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="merges-all-the-json-structures-coming-from-the-search-functions">merges all the JSON structures coming from the search functions</h3>
<p>some metaprogramming: calls all find functions listed above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>search_all
  r=[]
  [<span class="hljs-symbol">:find_histogram</span>,<span class="hljs-symbol">:find_density</span>,<span class="hljs-symbol">:find_statistics</span>,<span class="hljs-symbol">:find_original</span>, <span class="hljs-symbol">:find_classification</span>, <span class="hljs-symbol">:find_im</span>,<span class="hljs-symbol">:find_ct</span>].each <span class="hljs-keyword">do</span> |m|
    r &lt;&lt; <span class="hljs-keyword">self</span>.send(m)
    puts <span class="hljs-string">"Done with <span class="hljs-subst">#{m}</span>"</span>
  <span class="hljs-keyword">end</span>
  r.flatten
<span class="hljs-keyword">end</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NilClass</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span> to_sym
    <span class="hljs-keyword">false</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="query-to-ensure-that-entries-are-not-recreated-in-teh-database-but-only-paths-and-blobs-are-updated">query to ensure that entries are not recreated in teh database, but only paths and blobs are updated</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>make_query data_set
  <span class="hljs-keyword">if</span> data_set.has_key?(<span class="hljs-symbol">:new_old</span>)
    query={<span class="hljs-symbol">:case_n</span> =&gt; data_set[<span class="hljs-symbol">:case_n</span>],<span class="hljs-symbol">:cd_type=&gt;data_set</span>[<span class="hljs-symbol">:cd_type</span>], <span class="hljs-symbol">:new_old=&gt;data_set</span>[<span class="hljs-symbol">:new_old</span>]}
  <span class="hljs-keyword">elsif</span> data_set.has_key?(<span class="hljs-symbol">:tile</span>)
    query={<span class="hljs-symbol">:case_n</span> =&gt; data_set[<span class="hljs-symbol">:case_n</span>],<span class="hljs-symbol">:cd_type=&gt;data_set</span>[<span class="hljs-symbol">:cd_type</span>], <span class="hljs-symbol">:tile=&gt;data_set</span>[<span class="hljs-symbol">:tile</span>]}
  <span class="hljs-keyword">else</span>
    query={<span class="hljs-symbol">:case_n</span> =&gt; data_set[<span class="hljs-symbol">:case_n</span>],<span class="hljs-symbol">:cd_type=&gt;data_set</span>[<span class="hljs-symbol">:cd_type</span>]}
  <span class="hljs-keyword">end</span>
  query
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3 id="load-datasets-in-their-mongo-classes">load datasets in their mongo classes</h3>
<p>if entry preexisting updates results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> </span>mongo_load_all search_results=search_all(), json_class_mapper=<span class="hljs-constant">JSON_CLASS_MAPPER</span>
  search_results.each_with_index <span class="hljs-keyword">do</span> |data_set,i|
    puts <span class="hljs-string">"<span class="hljs-subst">#{i}</span>: <span class="hljs-subst">#{data_set}</span>"</span>
    puts data_set[<span class="hljs-string">"type"</span>]
    mm_class=( json_class_mapper[data_set[<span class="hljs-string">"type"</span>]].to_sym <span class="hljs-keyword">or</span> json_class_mapper[data_set[<span class="hljs-symbol">:type</span>]])
    puts <span class="hljs-string">"mm_class=<span class="hljs-subst">#{mm_class}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>puts “data set type=#{data_set[:type]}”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    puts <span class="hljs-string">"class =<span class="hljs-subst">#{mm_class}</span>"</span>
    query=make_query data_set
    puts <span class="hljs-string">"query= <span class="hljs-subst">#{query}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>query= {:case_n=&gt;”RS-SV-05-16335”, :cd_type=&gt;”CD8”, :tile=&gt;”CT4”}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> mm_class.where(query).all.empty?
      mm_object=mm_class.create data_set
      puts <span class="hljs-string">"mm created <span class="hljs-subst">#{mm_object}</span>"</span>
    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>upserts if entry pre-existing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      mm_class.set(query, data_set, <span class="hljs-symbol">:upsert</span> =&gt; <span class="hljs-keyword">true</span> )
      puts <span class="hljs-string">"uspsert created <span class="hljs-subst">#{mm_object}</span>"</span>
      mm_object=mm_class.where(data_set).find_one
    <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>binding.pry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mm_object.get_cd
    mm_object.save
   
  <span class="hljs-keyword">end</span>
  puts <span class="hljs-string">"\n\n\n"</span>
  puts <span class="hljs-string">"finished uploading to databes"</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>show graphic_data
  tf=<span class="hljs-constant">Tempfile</span>.new [<span class="hljs-string">"temp"</span>,<span class="hljs-string">".jpg"</span>]
  tf.write graphic_data
  tf.close
  puts <span class="hljs-string">"<span class="hljs-subst">#{tf.path}</span>"</span>
  fork <span class="hljs-keyword">do</span>
    `open <span class="hljs-comment">#{tf.path}`</span>
  <span class="hljs-keyword">end</span>
  <span class="hljs-constant">Process</span>.wait
  tf.unlink
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
